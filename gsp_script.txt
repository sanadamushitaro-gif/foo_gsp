function doPost(e) {
  try {
    if (!e || !e.postData) {
      return ContentService.createTextOutput("ERROR: no postData");
    }

    const data = JSON.parse(e.postData.contents);

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = "playlist";
    const sheet = ss.getSheetByName(sheetName) || ss.insertSheet(sheetName);

    // 毎回上書き: 既存内容を全て消してから再作成
    sheet.clearContents();
    sheet.getRange(1, 1, 1, 4).setValues([["Title", "Artist", "Album", "PlayCount"]]);

    const tracks = Array.isArray(data.tracks) ? data.tracks : [];

    const rows = tracks.map(t => ([
      t.title || "",
      t.artist || "",
      t.album || "",
      t.play_count || ""
    ]));

    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, 4).setValues(rows);
    }

    return ContentService.createTextOutput("ok tracks=" + tracks.length);

  } catch (err) {
    return ContentService.createTextOutput("ERROR: " + err);
  }
}
